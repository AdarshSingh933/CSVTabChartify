<link rel="stylesheet" href="/css/csvFileView.css">
<!--include google chart library-->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<nav class="navbar bg-body-tertiary">
    <div class="container-fluid">
      <form class="d-flex" role="search">
        <input class="form-control me-2" id="searchInput" type="search" placeholder="Search" aria-label="Search">
      </form>
    </div>
  </nav>
  <h4>Page <%= currentPage %></h4>
  <table class="table table-bordered">
    <thead>
        <tr>
            <% for (let header of headers) { %>
                <th scope="col" data-column="<%= header %>" class="sortable-header">
                    <%= header %>
                    <button class="sort-button" data-column="<%= header %>" data-order="asc">&#8593;</button>
                    <button class="chart-button" data-column="<%= header %>">Chart</button>
                </th>
            <% } %>
        </tr>
    </thead>
    
    <tbody>
        <% if (headers.length > 0) { %>

            <% // Render CSV file content with the corresponding headers %>
            <% for (let row of data) { %>
                <tr>
                    <% // Dynamically render table data based on the headers %>
                    <% for (let header of headers) { %>
                        <td data-column="<%= header %>">
                            <% if (row[header] !== undefined) { %>
                                <%= row[header] %>
                            <% } %>
                        </td>
                    <% } %>
                </tr>
            <% } %>
        <% } %>
            
    </tbody>
</table>
  <!--  chart container where the chart will be rendered. -->
  <div id="chartContainer"></div>

  <!-- Add this code to display pagination controls -->
  <div class="pagination">
    <p>pages</p>
    <ul class="pagination-list">
      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="<%= i === currentPage ? 'active' : '' %>">
          <a href="/csv/view-file?file=<%= requestedFilePath%>&&page=<%= i %>"><%= i %></a>
        </li>
      <% } %>
    </ul>
  </div>

<script>
  // Define the data variable in the global scope to make it accessible

  // Function to render a column chart
  function renderColumnChart(column, dataRows,headers) {
  google.charts.load('current', { packages: ['corechart'] });
  google.charts.setOnLoadCallback(drawChart);

  function drawChart() {
    console.log("drawchart");
    const chartData = new google.visualization.DataTable();
    chartData.addColumn('string', 'Category');
    chartData.addColumn('number', 'Value');

    // Find the index of the selected column based on data-column attribute
    console.log("headers",headers);
    const columnIndex = headers.findIndex(header => {
    return header.getAttribute('data-column') === column;
  });
    console.log("columnIndex",columnIndex);

    // Prepare the chart data from the selected column
    dataRows.forEach(row => {
      console.log("row", row);
      console.log("column", column);
      console.log("cellData",row.cells[columnIndex]);
      // Use the columnIndex to retrieve the cell data
      const cellData = row.cells[columnIndex].textContent;
      console.log("cellData", cellData);

      // Check if cellData is a valid number before adding it to the chart
      if (!isNaN(parseFloat(cellData))) {
        chartData.addRow([column, parseFloat(cellData)]);
      }
    });

    console.log("charData", chartData);

    const options = {
      title: `Column Chart for ${column}`,
      bars: 'vertical',
    };

    const chart = new google.visualization.ColumnChart(document.getElementById('chartContainer'));
    chart.draw(chartData, options);
  }
}

// ...

  
   // Function to attach event listeners for sorting and searching
  function attachEventListeners() {
  const table = document.querySelector('table');
  const headers = Array.from(table.querySelectorAll('.sortable-header'));
  const dataRows = Array.from(table.querySelectorAll('tbody tr'));

  headers.forEach(header => {

    // Attach click event to the chart button
    const chartButton = header.querySelector('.chart-button');
    if (chartButton) {
      const column = header.querySelector('.chart-button').getAttribute('data-column');
      chartButton.addEventListener('click', () => {
        renderColumnChart(column,dataRows,headers);
      });
    }
    const sortButton = header.querySelector('.sort-button');
    sortButton.addEventListener('click', () => {
      const column = header.querySelector('.sort-button').getAttribute('data-column');

      // Toggle sorting direction between ascending (1) and descending (-1)
      const direction = header.classList.contains('ascending') ? -1 : 1;
     
       // Update the arrow direction based on the sorting order
       sortButton.innerHTML = direction === 1 ? '&#8593;' : '&#8595;';

      // Sort data rows based on the selected column and direction
      dataRows.sort((rowA, rowB) => {
        const cellA = rowA.querySelector(`td[data-column="${column}"]`);
        const cellB = rowB.querySelector(`td[data-column="${column}"]`);
        

        if (!cellA || !cellB) {
          return 0; // Treat them as equal
        }

        const valueA = cellA.textContent;
        const valueB = cellB.textContent;
      


        if (valueA < valueB) return -1 * direction;
        if (valueA > valueB) return 1 * direction;
        return 0;
      });

      // Remove existing rows from the table
      dataRows.forEach(row => table.tBodies[0].removeChild(row));

      // Append sorted rows back to the table
      dataRows.forEach(row => table.tBodies[0].appendChild(row));

      // Toggle sorting direction class
      headers.forEach(header => header.classList.remove('ascending', 'descending'));
      header.classList.toggle(direction === 1 ? 'ascending' : 'descending');
    });
  });

  // Get references to the input field and table body
  const searchInput = document.getElementById('searchInput');
  const tableBody = document.querySelector('tbody');

  // Listen for changes in the input field
  searchInput.addEventListener('input', function () {
    const searchTerm = this.value.toLowerCase(); // Get the search term and convert to lowercase

    // Loop through each row in the table
    dataRows.forEach(row => {
      const rowData = Array.from(row.children).map(cell => cell.textContent.toLowerCase()); // Get the text content of each cell in lowercase

      // Check if any of the cell content contains the search term
      if (rowData.some(cellContent => cellContent.includes(searchTerm))) {
        row.style.display = ''; // Show the row if it contains the search term
      } else {
        row.style.display = 'none'; // Hide the row if it doesn't contain the search term
      }
    });
  });
}

// Attach event listeners when the document is ready
document.addEventListener('DOMContentLoaded', () => {
  attachEventListeners();
});

</script>


